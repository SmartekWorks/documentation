フローデータ
===

フローもしくはシナリオが関わるデータは主に下記になります。

* 入力データ：フローもしくはシナリオの入力引数が決めた一連のデータです。フローの呼び出し元やケースなどの外部データソースから提供します。
* 出力データ：フローもしくはシナリオの出力引数が決めた一連のデータです。フロー実行時に作成したデータを利用します。
* ステップデータ：フローの各ステップに利用するデータです。

フロー引数
---

フローの引数は入力引数と出力引数に分かれます。

### 入力引数

入力引数はフローの実行に外部からもらう必要なデータです。フローステップに`@{変数名}`<sup>1</sup>のように定義したローカル変数とフローの設定に明示的に定義した入力引数からフローの入力引数が定義されます。フローの実行時に、それらの引数と関連する変数から入力データをアクセスすることが可能です。

?> 1. データスコープとグローバルスコープの変数は入力引数になりませんので、それらのデータはフローの中で生成することになります。

### 出力引数

フローの設定に明示的に定義した出力引数からフローの出力引数が定義されます。フローが実行完了後に、それらの引数と関連する変数のデータを利用して、出力引数のJSONマップを下記のように出力します。

* シナリオの場合，出力引数のデータはシナリオデータファイルに書込みます<sup>1</sup>。
* フローの場合、出力引数のデータはこのフローを呼び出すステップの出力変数に格納されます。後続のステップにそれらの変数を経由して、データを利用します。

?> 1. SWATHubロボットのオフライン端末モードのみ利用可能です。

ステップデータ
---

ステップの入力データはステップを定義する際に決めた該当ステップの実行に必要なデータです。ステップ実行後の出力データは該当ステップの出力引数に定義した変数に保存されます。それらのデータの内容とタイプは該当ステップと関連したコンポーネントの引数が決めます。引数の構成について、フローの場合に[#フロー引数]を参照してください。モデルオペレーションとシステムオペレーションはそれぞれのドキュメントを参照してください。

### 入力データ

ステップのデータはJSのデータタイプをサポートしています。例えば、`boolean`、`number`、`string`、`object`、`map`、`array`などの基本データタイプ、また、`Date`、`null`、`undefined`、`NaN`、`infinity`などの特殊タイプも利用できます。データを下記の方法で定義することができます。

* テキストデータ：ステップの引数入力ボックスに直接文字列を入れた`string`タイプのデータです。データの中に`@{変数名}`のように変数が利用できます。
* スクリプトデータ：ステップの引数入力ボックスに二つの**\`**に囲まれた標準JSの文字列です。このスクリプト実行して戻ったデータはステップデータとして利用されます。スクリプトにJSの文法でスクリプトに定義した変数や、外部の変数<sup>1</sup>を利用することが可能です。

下記はスクリプトデータのサンプルです。
```javascript
`var obj={"username":"Alice","password":"123456"};obj;`
```

?> 1. スクリプトに外部定義した変数の値を変更した場合に、この変更は後続のステップに反映されます。

変数
---

フローのデータに固定のデータが利用できる他に、変数も利用できます。それらの変数は外部からのデータを保存したり、ステップの間のデータを引き渡したり機能します。SWATHubの変数はユーザーが定義できる[ユーザー変数](#ユーザー変数)とシステムが定義する[システム変数](#システム変数)に分かれています。

### ユーザー変数

ユーザー変数はユーザーが定義した変数です。スクリプトのJSで変数を定義することもできますし、データ項目に`@{変数名}`の形に定義することも可能です。後者を利用する場合に、JSの文法を分からなくてもシンプルに利用できますが、下記のいくつかの制限と利用方法があります。

* 変数名は、数字、アルファベット、中国語/日本語の文字と`_`の文字列でなければなりません。
* `@{変数名}`の値は文字列タイプなので、その他のタイプの場合に、自動的に文字列に変換されます。
* もし変数の値がJSONマップもしくは配列の場合に、`@{変数名[1].属性1}`のような取得方法（変数配列の2番目のマップの属性1の値）で、便利にエレメントの値を取得することができます。

#### 変数のスコープ
変数のスコープは下記の三つになります。

* データスコープ：データ項目のスクリプトにしか利用できません。
* ローカルスコープ：定義した階層のフォローにしか利用できません。
* クローバルスコープ：シナリオの各階層のフローに利用できます。

スクリプトの中に定義した変数はデータスコープです。`@{変数名}`の形式に定義した変数は通常ローカルスコープですが、`@{_変数名}`のように、変数名の先頭に_を追加することでグローバルスコープになります。

子フローのデータを親フローに変数で渡す場合に、グローバルスコープの変数を利用する他に、子フローの出力引数で親フローの変数にに渡すことも可能です。

### システム変数

システム変数は実行時にSWATHubがその時点の状態の特殊な値を与える変数で、`${var}`<sup>1</sup>の形式で引数データフィールドに設定することができます。現在ではサポートしているシステム変数は下記になります。

?> 1. システム変数では大文字と小文字を区別します。

#### `${HTML}`

現在アクティブなウィンドウのHTMLソースを格納する変数です。値は下記キーを含むのJSONマップになります。

* `source`: ルートドキュメントのHTMLソース。
* `frames`: フレームの`handle`をキーにするフレーム情報のJSONマップです。
  * `handle`: フレームの番号、例えば、`0`は1番目の子供フレーム、`0_1`は1番目の子供フレームの配下の2番目の子供フレーム。
  * `name`: フレームの名前もしくはID。
  * `source`: フレームドキュメントのHTMLソース。

#### `${prevStepPath}`

直前のステップのエビデンスを保存する絶対パスです。例えば、`C:\Users\<username>\AppData\Roaming\SWATHubRobot\tasks\160fd0162bc0464e8dda83ef8233fa95\result\2\`のエビデンスパスです。下記のように実際のエビデンスを取得することが可能です。

* `${prevStepPath}snap001.png`: 1枚目のスクリーンショット
* `${prevStepPath}src.html`: HTMLソース
* `${prevStepPath}extra\data.zip`: ダウンロードしたデータ

?> Mac OSの場合、Windowsと異なる区切り文字を利用するため、`/Users/<username>/Library/Application Support/SWATHubRobot/tasks/256fded1bc364bfe88f84fb39726ac66/result/2/`のようなパスになります。

#### `${lastAlertText}`

直近の[アラート処理](flow_step_option.md#browseralert)が発生したステップに保存したアラートのテキストです。

#### `${scenarioID}`

この実行中タスクのシナリオのID。

#### `${scenarioName}`

この実行中タスクのシナリオの名前。

#### `${caseID}`

この実行中タスクのケースのID。

#### `${caseName}`

この実行中タスクのケースの名前。

#### `${taskCode}`

この実行中タスクのコード。

#### `${os}`

この実行中タスクのOSとバージョン情報、例えば`Windows 10`。

#### `${browser}`

この実行中タスクのブラウザとバージョン情報、例えば`Chrome 86`。

#### `${env}`

この実行中タスクの環境変数、利用時に`${env.環境変数名}`<sup>1</sup>もしくは`${env[環境変数名]}`で特定の環境変数の値を取得します。環境変数を下記のところにJSONマップの形で定義することが出来ます。

* シナリオグループのデフォルト設定で定義。
* GUIもしくはAPIの実行設定で定義。
* シナリオパッケージがオフライン実行時の入力データで定義。

?> 1. 環境変数名は数字、アルファベット、中国語/日本語の文字と`_`の文字列でなければなりません。

#### `${errorMessage}`

CATCHブロックで取得したエラーメッセージ。
