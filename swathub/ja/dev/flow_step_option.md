ステップオプション
===

フローのステップを実行する際にステップオプションを利用して、実行の振る舞いを細かく制御し、様々なユーザーアプリ実行環境に適応することが可能です。ステップオプションを下記のように定義します。

* 特定なステップを設定する場合、該当ステップの定義にはオプションを設定します。
* フローの全てのステップを設定する場合、該当フローを呼び出すステップの定義にはオプションを設定します。
* シナリオの全てのステップを設定する場合、デバッグもしくはテスト時に記入するか、シナリオ設定ファイルに記述するか設定します。

ステップオプションはいくつか設定キーと設定値を構成したJSONマップです。それらの設定は機能的に下記のに分類されています。

* [フロー制御](#フロー制御)
* [ブラウザ設定](#ブラウザ設定)
* [ブラウザアクション](#ブラウザアクション)
* [モバイルとGUI設定](#モバイルとGUI設定)
* [テスト機能](#テスト機能)

フロー制御
---

#### `ignoreError`
ステップに実行エラーが発生する際、エラーを無視し次のステップの実行を継続するかどうか定義します。

* 下記の値を使用します。デフォルトは`none`。
  * `none`: ステップでエラーが発生する場合シナリオの実行がエラーで終了。
  * `ignore`: ステップでエラーが発生する場合実行を継続しますが、実行結果をエラーにします。
  * `silentIgnore`: ステップでエラーが発生する場合実行を継続しますが、エラーを実行結果に反映しません。
* `ignoreError`はアサーションのエラー処理優先度より高いので、この設定を利用した場合に、アサーションのエラー処理が無視されます。

#### `commandInterval`
オペレーションの中にある二つの連続アクション間（例えば、フォームに各項目を記入するアクション間）の時間間隔を定義します。

* ミリ秒単位。
* 非負の整数を使用します。デフォルトは`0`。

#### `operationInterval`
ステップが実行完了後の待ち時間を定義します。

* ミリ秒単位。
* 非負の整数を使用します。デフォルトは`0`。

#### `recursiveCallDepth`
シナリオにフローを呼び出す最大深さを定義します。例えば、シナリオ1がフロー1を呼ぶ時深さは`1`、フロー1がさらにフロー2を呼ぶ時深さは`2`。

* 非負の整数を使用します。デフォルトは`3`。
* `recursiveCallDepth`はシナリオの属性のため、シナリオのデフォルトステップオプションに設定する必要があります。

#### `stepBypass`

ステップの[バイパス](flow_control#ステップバイパス)機能が有効するかを定義します。デフォルトは`true`。

#### `stepValidate`

ステップの入力パラメーターをチェックするかどうか定義します。デフォルトは`true`。

ブラウザ設定
---

#### `browserTimeout`
WebDriverのタイムアウト値を定義します。

* 秒単位。
* 正の整数を使用します。デフォルトは`30`。
* ブラウザ起動時に設定する必要があるため、ブラウザを起動させるステップ、もしくはシナリオに設定する必要があります。

#### `browserWidth`
初期のブラウザウィンドウ幅を定義します。

* `100`と`2000`の間の整数を使用します。デフォルトは`1280`。
* ブラウザ起動時に設定する必要があるため、ブラウザを起動させるステップ、もしくはシナリオに設定する必要があります。

#### `browserHeight`
初期のブラウザウィンドウの高さを定義します。

* `100`と`2000`の間の整数を使用します。デフォルトは`800`。
* ブラウザ起動時に設定する必要があるため、ブラウザを起動させるステップ、もしくはシナリオに設定する必要があります。

#### `browserMaximize`
ウィンドウを最大化を定義します。

* `true`か`false`を使用します。デフォルトは`false`。
* 最大化する場合`browserWidth`か`browserHeight`の値を無視します。
* ブラウザ起動時に設定する必要があるため、ブラウザを起動させるステップ、もしくはシナリオに設定する必要があります。

#### `browserDownloadDir`
ブラウザのダウンロード先を定義します。

* パスの文字列を使用します。デフォルトは空白。
* ロボット設定に定義したダウンロードディレクトリを優先度高いです。
* ブラウザ起動時に設定する必要があるため、ブラウザを起動させるステップ、もしくはシナリオに設定する必要があります。

#### `browserCapabilities`
WebDriverに追加するCapabilitiesを定義します。

* Capabilitiesキーと値のJSONマップを使用します。デフォルトは`{}`。
* ブラウザ起動時に設定する必要があるため、ブラウザを起動させるステップ、もしくはシナリオに設定する必要があります。

#### `browserEmulations`

WebDriverの代わりにJavascriptや、UI自動化でブラウザをエミュレーションします。WebDriverがうまく稼働しない場合に活用できます。

* 下記のオプションキーと値のマップの配列を使用します。デフォルトは`[]`。
  * `browser`: ブラウザの名前、現時点、`IE`、`Firefox`、`Chrome`、`Safari`、`Edge`と`Edge Legacy`は利用可能。必須項目です。
  * `oss` : OSの配列。セットしない場合、全てのOSになります。
  * `versions`: ブラウザバージョンの配列。セットしない場合、全てのバージョンになります。
  * `actions`: エミュレートしたいアクションの配列です。現時点、`click`、`check`、`select`と`type`は対応されています。セットしない場合、エミュレートしません。
  * `mode`: エミュレーションを発動するタイミング。下記の値のいずれかを利用する必要があります。
    * `all`: `actions`に定義した全ての操作で利用します。
    * `error`: エラーの時だけ、利用します。例えば、操作要素が隠されて、WebDriverが操作できなくエラーが発生した時。
    * `none`: エミュレーションをしません。
  * `axis`: エミュレーションで操作する対象はWebDriverの操作対象に対する[Relative xpath](https://developer.mozilla.org/en-US/docs/Web/XPath/Axes)です。セットする場合、本来の操作対象の代わりに新たに指定した要素に対してエミュレーション操作をします。

#### `chromeOptions`
Chromeのための追加オプションです。

* オプションキーと値はマップを使用します。デフォルトは`{}`。
* 可能のオプションについて、[ここ](https://sites.google.com/a/chromium.org/chromedriver/capabilities)を参照ください。よく利用するのは下記のモバイルエミュレーションのためのオプションです。
  * `mobileEmulation`: **deviceName**の値、もしくは、 **deviceMetrics**、 **userAgent**の値のいづれかのマップです。**deviceName**は、DevToolエミュレーションパネルで設定できる既知のデバイスであることが必要です。例えば、`{"mobileEmulation":{"deviceName":"Google Nexus 5"}}`
* ブラウザ起動時に設定する必要があるため、ブラウザを起動させるステップ、もしくはシナリオに設定する必要があります。

#### `ieOptions`
Internet Explorerのための特殊設定です。

* 下記のオプションキーと値はマップを使用します。デフォルトは`{}`。
  * `scriptClick`: WebDriverの代わりに、Javascriptのclick()を利用して、クリックをエミュレートする設定です。値は、利用するIEバージョンの文字列（`,`で繋ぐ）です。例えば、`"7,9,11"`はIE 7、9、11の場合、この機能を利用することを意味します。デフォルトは空白。
  * `scriptType`: WebDriverの代わりに、Javascriptのフォーカス、値セットなどでテキストの記入をエミュレートする設定です。値は、利用するIEバージョンの文字列（`,`で繋ぐ）です。例えば、`"7,9,11"`はIE 7、9、11の場合、この機能を利用することを意味します。IE8以下利用できません。デフォルトは空白。
  * `textCheck`: テキスト入力後に一度正しく入力したかをチェックして、間違った場合、再入力する機能です。値は、利用するIEバージョンの文字列（`,`で繋ぐ）です。例えば、`"7,9,11"`はIE 7、9、11の場合、この機能を利用することを意味します。デフォルトは空白。
  * `textMax`: テキスト入力の際に、テキストを`textMax`の文字数で分割して数回入力します。非負の整数を使用してください。分割しない場合、`0`を使用します。デフォルトは`0`。

#### `edgeOptions`
Edgeのための特殊設定です。

* 下記のオプションキーと値はマップを使用します。デフォルトは`{}`。
  * `basicAuthTimeout`: Basic認証の認証ダイアログのOKボタンを押す機能です。値は秒単位でダイアログが出るまで待つ時間です。0の場合該当機能を実行しません。非負の整数を使用します。デフォルトは`0`。

#### `browserScreenshot`
ブラウザのスクリーンキャプチャーを定義します。

* 下記のオプションキーと値はマップを使用します。デフォルトは`{}`。
  * `fullscreen `: ブラウザスクリーンショットの代わりにデスクトップスクーンショットを利用するかどうか、`true`もしくは`false`を使用します。デフォルトは`false`。
  * `fullscreenScroll`: デスクトップスクーンショットを利用する場合、コンテンツ内容をスクロールしてスクリンショットを撮るかどうか、`true`もしくは`false`を使用します。デフォルトは`false`。
  * `scrollOffset`: スクリーングショットをスクロールで撮る際に、固定なトップバーの高さ（Pixel）を補正する設定です。整数を使用します。デフォルトは`0`。
  * `composite`：ページにスクロールバーが存在する場合、全画面のスクリーンショットを合成するかどうか。`true`または`false`を使用します。デフォルト値は`true`です。
  * `scrollableFrames`: 対象フレームに個々のスクロールスクリーンショットを撮ります。フレーム (以下のキーを持つJSONオブジェクト) の配列を使用します。デフォルトは`[]`。
    * `id`: フレームのID。例えば、`{"id":"frame2"}`。
    * `name`: フレームの名前。例えば、`{"name":"frame2"}`。
    * `scrollOffset`：トップフローティングバーがあるフレームでスクロールスクリーンショットを撮るとき、スクロール距離を修正できます。整数を使用します。デフォルト値は`0`。
    * `composite`：フレームにスクロールバーがある場合、全体のスクリーンショットを合成するかどうか。`true`または`false`を使用します。デフォルト値は`true`。
  * `scrollableElements`: 対応エレメントに個々のスクロールしたスクリーンショットを撮ります。エレメント (以下のキーを持つJSONオブジェクト) 配列を使用します。デフォルトは`[]`。
    * `id`: エレメントのID。例えば、`{"id":"shopping_cart"}`。
    * `css`: エレメントのcssセレクター(IE9+)。例えば、`{"css":"div.main_menu"}`。
    * `frame`: 対象エレメントが所在のフレーム(以下のキーを持つJSONオブジェクト)。
        * `id`: フレームのID。例えば、`{"id":"frame2"}`。
        * `name`: フレームの名前。例えば、`{"name":"frame2"}`。

#### `browserScrollIntoView`
画面要素を操作する前に、表示されるようにスクロールする機能です。

* 下記の値を使用します。デフォルトは`none`。
  * `none`: スクロールしません。
  * `top`: 画面要素を表示されるエリアをトップにスクロールします。
  * `bottom`: 画面要素を表示されるエリアのボトムにスクロールします。
  * `middle`: 画面要素を表示されるエリアの真ん中にスクロールします。
* 一部のブラウザで表示されない要素を操作できない場合に利用できます。

#### `browserFrameDepth`
処理するためのフレームの最大深さを定義します。

* 非負の整数を使用します。デフォルトは`3`。

#### `browserPageRefresh`
ステップを実行した後に、画面のHTMLソースを再取得するかどうか定義します。

* `true`か`false`を使用します。デフォルトは`true`。
* 画面変化のないステップに`false`を利用することで、実行の性能を向上することが可能です。

#### `browserFindByCSS`
画面要素を処理する際にxPathの代わりにCSS属性で指定するかどうか定義します。

* `true`か`false`を使用します。デフォルトは`false`。
* HTML構文不正などの原因でxPathが利用できない場合に役に立ちます。

#### `browserKeepSession`
実行完了時に、ブラウザの操作セッションを終了させるかどうかを定義します。`URLに遷移`オペレーションのみに対して有効です。

* `true`か`false`を使用します。デフォルトは`false`。

ブラウザアクション
---

#### `browserAlert`
ブラウザで発生したアラートアクションをハンドルする方法を定義します。予期しないアラートが実行の失敗原因になります。従ってアラートが存在するステップにこのオプションの設定が必要です。

* 下記のオプションキーと値はマップを使用します。デフォルトは`{}`（処理しない）。
  * `action`: オペレーション後のアラートを処理する方法を定義します。`accept`、`dismiss`、`ignore`は対応されます。デフォルトは`accept`。
  * `timeout`: アラートが表示されるまで待機する時間（秒）を定義します。デフォルトは`5`。
  * `times`: 処理する一連のアラートの回数をを定義します。デフォルトは`1`。
  * `screenshot`: アラートが表示された時にデスクトップのスクリーンショットを撮るかどうか。デフォルトは`false`。

#### `browserDownload`
ブラウザから発生したダウンロードアクションをハンドルする方法を定義します。

* 下記のオプションキーと値はマップを使用します。デフォルトは`{}`（処理しない）。
  * `promptTimeout`: 該当オペレーションが実行されてからダウンロードアクション（ファイルダイアログなど）が開始するまで待機する時間（秒）を定義します。FirefoxとChromeのダウンロード確認ダイアログが自動的に表示されなくなるため、このタイムアウトは**Internet Explorer**に対してのみ有効です。デフォルトは`5`。
  * `completeTimeout`: ダウンロードするファイルの所要時間（秒）を定義します。ダウンロードが完了し、ファイルが読み込まれるとこのステップのエビデンスにされます。デフォルトは`30`。
* 実際のダウンロードとアップロードの動作をシミュレートするには、OSの機能が関係し、シナリオを不安定にするため注意が必要です。
* ロボットの設定にダウンロードディレクトリを設定する必要があります。
* 通常、ブラウザには、ファイルがローカルディスクにダウンロードされる前に確認ダイアログを有効/無効にするオプションがあります。これらのダイアログを非表示にし、ファイルを自動的にダウンロードするためには下記の通り、各ブラウザでの設定が必要です。
  * **Chrome**と**Firefox** の場合、ロボットが自動的に設定を行うため、手動で特別に設定する必要がありません。
  * **Internet Explorer** もデフォルトで設定されているが、**Default download location**をロボット設定に定義されたダウンロードディレクトリに一致しなければいけません。**Tools > View downloads > Options**メニューからダウンロード場所の変更が可能です。
  * **Microsoft Edge** は自動ダウンロードに合わせて調整する必要があります。ステップは次のとおりです：**Settings > View advanced settings > Ask me what to do with each download**をオフにします。また、高度な設定の中でダウンロード場所をダウンロードディレクトリと同じように設定してください。
  * **Safari** は本質的にサイレントダウンロードをサポートしていますが、ダウンロードが完了した後にファイルを開こうとします。このオプションを無効にする手順は次のとおりです：**Preferences > General > Open 'safe' files after downloading**のチェックを外します。デフォルトのダウンロード場所がダウンロードディレクトリと同じであることを再確認してください。

アプリ設定
---

#### `winappTimeout`

Windowsコントロールをローケーティングするタイムアウト値を定義します。

* 秒単位。
* 正の整数を使用します。デフォルトは`15`。

#### `guiTimeout`
GUIエレメントをローケーティングするタイムアウト値を定義します。

* 秒単位。
* 正の整数を使用します。デフォルトは`15`。

#### `mobileTimeout`
Nativeアプリのエレメントをローケーティングするタイムアウト値を定義します。

* 秒単位。
* 正の整数を使用します。デフォルトは`30`。

#### `mobileTextClear`

入力する前に既存のテキストをクリアするかどうかを定義します。

* `true`か`false`を使用します。デフォルトは`true`。
* 日付選択と同様のドロップダウンコントロールを操作する場合、通常は`false`に設定する必要があります。

#### `mobileScrollIntoView`

ネイティブAPPの要素を操作する前にビューポートにスクロールするかどうかを定義します。

* `true`か`false`を使用します。デフォルトは`false`。
* ネイティブAPPで操作対象が隠されて操作できない場合に`true`にする必要があります。
* ハイブリッドAPPのWebViewの要素の場合に通常スクロールなしで操作が可能ですが、必要のある場合に代わりに`browserScrollIntoView`を利用してください。

#### `mobileKeepSession`

実行完了時に、ネイティブAPPの操作セッションを終了させるかどうかを定義します。`APPを起動`オペレーションのみに対して有効です。

* `true`か`false`を使用します。デフォルトは`false`。

#### `mobileCapabilities`

Appium DriverのCapabilitiesを増やします。

* CapabilitiesのMAPを使用してオプションと値を設定します。デフォルト値は`{}`です。
* この設定は、[APPを起動](sop_mobileapp#APPを起動)ステップ、または全体のフローで設定する必要があります。

#### `apiOptions`

APIオペレーションの特殊設定です。

* 下記のオプションキーと値はマップを使用します。デフォルトは`{}`。
  * `useSystemProxy`: ロボット設定のシステムプロキシを利用するかどうか、`true`か`false`を使用します。デフォルトは`false`。
  * `rejectUnauthorized`: 未署名の証明書を拒否するかどうか、`true`か`false`を使用します。デフォルトは`false`。

### `llmOptions`

AIオペレーションの特殊設定です。

* 異なる大規模言語モデルによって設定が異なる場合があります。デフォルトは`{}`。以下は`gpt-4`を使用する例です。

``` json
  "llmOptions": {
    "model": "openai",
    "openaiApiKey": "sk-xxx",
    "openaiModel": "gpt-4",
    "openaiBaseUrl": "https://api.openai.com"  
  }
```

テスト機能
---

#### `evidenceLevel`
エビデンス取得の異なるレベルを定義します。

* 下記の値を使用します。テスト時のデフォルトは`2`、業務運用時のデフォルトは`0`。
  * `0`: エラーステップのためのHTMLソースとスクリーンショットのみはエビデンスとして保存されます。
  * `1`: アサーションシステムオペレーションまたはエラーステップのためのHTMLソースとスクリーンショットはエビデンスとして保存されます。
  * `2`: すべてのケースステップのHTMLソースとスクリーンショットは、エビデンスとして保存されます。
  * `3`: すべてのケースステップのスクリーンショットは、エビデンスとして保存されます。

#### `stepDiff`
ステップのエビデンスをベースラインの実行結果と比較する方法を定義します。

* 比較対象 (以下のキーを持つJSONオブジェクト) の配列を使用します。デフォルトは`[]`。
  * `type`: 比較の種類です。`image`、`html`と`text`三種類の比較をサポートしています。HTMLの場合、`html`と`text`両方の比較が可能です。前者はDOMレベルの比較ですが、後者はテキストレベルの比較です。フレームを利用する場合、`html`はメインフレームの比較となりますので、`text`を利用することが必要です。
  * `content`: 比較対象です。現在、`html`と`screenshot`はサポートされています。
  * `seqs`: 比較対象が複数存在する場合、特定の対象のシーケンス番号で指定することが可能です。例えば、`[1,3]`は一番目と三番目のエビデンス（スクリーンショットとか）を比較します。セットしない場合、すべてのエビデンスを比較します。
  * `settings`: 比較機能に転送する設定のJSONマップです。現在、`exclude`はサポートされています。
    * `exclude`（画像比較）: 比較対象外のエリアを画像座標（`x`, `y`, `width`と`height`。で定義します。例えば、`[[50,50,100,100], [200,200,80,80]]`はスクリーンショットの(50,50)からの100x200のエリアと(200,200)からの80x80のエリアを比較対象外にします。
    * `exclude`（HTML比較）: 比較対象外のエリアをCSSセレクターで定義します。例えば、`["#ads-area", ".popup"]`は指定したDOM要素をすべて比較対象外にします。
